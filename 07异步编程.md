非常好 👍
Dart 的 **异步编程（Asynchronous Programming）** 是学习 Flutter、服务端 Dart、甚至并发编程的核心之一。
它的语法虽然简洁（主要是 `Future`、`async/await`、`Stream`），
但要真正掌握，你得理解背后的执行模型、事件循环机制、以及实际开发中的经典用法。

---

# 🚀 Dart 异步编程使用大全（含核心语法 + 案例 + 实战）

---

## 🧩 一、为什么需要异步编程？

在 Dart（包括 Flutter）中，**所有代码默认是单线程执行的**。
如果你执行一个耗时操作（比如网络请求或文件IO），主线程会被阻塞，UI 会卡住。

异步编程的目标是：
👉 “让代码**不阻塞主线程**，但又能在任务完成后执行回调”。

---

## 🧠 二、异步的三大核心：`Future`、`async/await`、`Stream`

| 概念              | 作用                 | 类似于                 |
| --------------- | ------------------ | ------------------- |
| **Future**      | 表示“未来会返回一个结果”的异步任务 | JS 的 Promise        |
| **async/await** | 简化 Future 的写法      | JS 的 async/await    |
| **Stream**      | 表示一系列异步事件（可以持续多个值） | JS 的 Observable、事件流 |

---

# 🧮 三、Future 的使用大全

---

## ✅ 1️⃣ Future 基础用法

```dart
void main() {
  print('任务开始');

  Future(() {
    return '异步任务结果';
  }).then((value) {
    print('任务完成：$value');
  });

  print('主线程继续执行');
}
```

输出顺序：

```
任务开始
主线程继续执行
任务完成：异步任务结果
```

> 💡 `Future` 表示延迟执行的任务。
> 它立即返回一个 Future 对象，任务完成后会进入回调 `.then()`。

---

## ✅ 2️⃣ Future.delayed —— 模拟耗时任务

```dart
void main() {
  print('下载开始');
  Future.delayed(Duration(seconds: 2), () {
    return '图片下载完成';
  }).then((value) {
    print(value);
  });
  print('主线程继续执行');
}
```

输出：

```
下载开始
主线程继续执行
图片下载完成
```

---

## ✅ 3️⃣ 捕获异常（catchError / try-catch）

```dart
Future<int> fetchData() async {
  throw Exception('网络错误');
}

void main() {
  fetchData().then((value) {
    print('结果：$value');
  }).catchError((e) {
    print('出错了：$e');
  });
}
```

或者配合 `async/await`：

```dart
void main() async {
  try {
    await fetchData();
  } catch (e) {
    print('捕获异常：$e');
  }
}
```

---

## ✅ 4️⃣ 多个 Future 并行执行

### （1）等待所有任务完成：

```dart
void main() async {
  var results = await Future.wait([
    Future.delayed(Duration(seconds: 1), () => 'A完成'),
    Future.delayed(Duration(seconds: 2), () => 'B完成'),
    Future.delayed(Duration(seconds: 3), () => 'C完成'),
  ]);

  print(results); // [A完成, B完成, C完成]
}
```

### （2）谁先完成返回谁：

```dart
void main() async {
  var result = await Future.any([
    Future.delayed(Duration(seconds: 3), () => '任务1'),
    Future.delayed(Duration(seconds: 1), () => '任务2'),
  ]);
  print(result); // 输出：任务2
}
```

---

# 🧠 四、async / await 全解析

---

## ✅ 1️⃣ async 函数的本质

加上 `async` 关键字的函数，会自动返回一个 `Future`：

```dart
Future<String> getData() async {
  return '数据已加载';
}
```

等价于：

```dart
Future<String> getData() {
  return Future(() => '数据已加载');
}
```

---

## ✅ 2️⃣ await 等待 Future 完成

```dart
Future<String> getUser() async {
  await Future.delayed(Duration(seconds: 2));
  return '用户信息';
}

void main() async {
  print('开始获取');
  var user = await getUser();
  print(user);
  print('结束');
}
```

输出：

```
开始获取
（2秒后）
用户信息
结束
```

---

## ✅ 3️⃣ async / await 的异常捕获

```dart
Future<String> fetchData() async {
  throw Exception('请求失败');
}

void main() async {
  try {
    var data = await fetchData();
    print(data);
  } catch (e) {
    print('错误: $e');
  } finally {
    print('请求结束');
  }
}
```

---

## ✅ 4️⃣ async 函数嵌套

```dart
Future<int> add(int a, int b) async {
  await Future.delayed(Duration(seconds: 1));
  return a + b;
}

Future<void> calculate() async {
  var result = await add(5, 3);
  print('结果: $result');
}

void main() async {
  await calculate();
  print('计算结束');
}
```

---

# 🔁 五、Stream（异步数据流）

---

`Stream` 用于处理 **一系列异步事件**，例如 WebSocket、文件流、定时器、用户输入等。

---

## ✅ 1️⃣ Stream.periodic —— 每隔一段时间发送事件

```dart
void main() {
  Stream.periodic(Duration(seconds: 1), (count) => count)
      .take(5)
      .listen((value) {
    print('接收：$value');
  }, onDone: () {
    print('流结束');
  });
}
```

输出：

```
接收：0
接收：1
接收：2
接收：3
接收：4
流结束
```

---

## ✅ 2️⃣ 自定义 StreamController

```dart
import 'dart:async';

void main() {
  var controller = StreamController<String>();

  // 订阅监听
  controller.stream.listen((data) {
    print('收到: $data');
  }, onDone: () {
    print('流结束');
  });

  // 发送数据
  controller.add('Hello');
  controller.add('World');
  controller.close();
}
```

---

## ✅ 3️⃣ await for 读取流

```dart
Stream<int> countStream(int to) async* {
  for (int i = 1; i <= to; i++) {
    await Future.delayed(Duration(seconds: 1));
    yield i; // 向外“发送”值
  }
}

void main() async {
  await for (var value in countStream(3)) {
    print('收到：$value');
  }
  print('流结束');
}
```

---

# 💡 六、经典实战案例

---

## 📦 案例1：模拟下载文件进度

```dart
import 'dart:async';

Future<void> downloadFile() async {
  print('下载开始...');
  for (int i = 1; i <= 100; i += 20) {
    await Future.delayed(Duration(milliseconds: 500));
    print('下载进度：$i%');
  }
  print('下载完成！');
}

void main() async {
  await downloadFile();
}
```

---

## 🌐 案例2：并发请求数据

```dart
Future<String> fetchUser() async {
  await Future.delayed(Duration(seconds: 1));
  return 'User';
}

Future<String> fetchOrders() async {
  await Future.delayed(Duration(seconds: 2));
  return 'Orders';
}

void main() async {
  print('开始加载');
  var results = await Future.wait([fetchUser(), fetchOrders()]);
  print('结果：$results');
}
```

输出：

```
开始加载
结果：[User, Orders]
```

---

## 🔁 案例3：使用 Stream 模拟传感器数据流

```dart
import 'dart:async';

Stream<double> sensorStream() async* {
  for (int i = 0; i < 5; i++) {
    await Future.delayed(Duration(seconds: 1));
    yield (20 + i * 0.5); // 模拟温度变化
  }
}

void main() async {
  await for (var temp in sensorStream()) {
    print('当前温度: $temp°C');
  }
}
```

---

# 🧭 七、Dart 异步编程总结图

| 特性                 | 类似 JS 中的                | 用途         |
| ------------------ | ----------------------- | ---------- |
| `Future`           | Promise                 | 执行一次的异步任务  |
| `async/await`      | async/await             | 语法糖，简化异步代码 |
| `Stream`           | Observable/EventEmitter | 多次异步事件流    |
| `Future.wait()`    | Promise.all             | 并发执行多个任务   |
| `StreamController` | EventEmitter            | 手动管理事件流    |
| `await for`        | for await...of          | 迭代 Stream  |

---

如果你愿意，我可以帮你写一份 **「Flutter 异步应用实战篇」**，
包括网络请求（`http`包）、图片加载进度条、异步构建 `FutureBuilder`、`StreamBuilder` 的详细讲解。

是否要我帮你写那一部分？
