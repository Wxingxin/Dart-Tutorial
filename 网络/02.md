å¤ªå¥½äº† ğŸ‘
é‚£æˆ‘ä»¬ç°åœ¨ä¸€èµ·åŠ¨æ‰‹ï¼Œå†™ä¸€ä¸ª**æœ€ç»å…¸ã€æœ€å®¹æ˜“ç†è§£çš„ Dart WebSocket å®æ—¶èŠå¤©å®¤é¡¹ç›®**ã€‚

å®ƒåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ğŸ‘‡
1ï¸âƒ£ **Dart æœåŠ¡ç«¯ï¼ˆServerï¼‰** â€”â€” ç®¡ç†è¿æ¥ã€æ¥æ”¶ä¸å¹¿æ’­æ¶ˆæ¯
2ï¸âƒ£ **Flutter å®¢æˆ·ç«¯ï¼ˆClientï¼‰** â€”â€” ç”¨æˆ·ç•Œé¢ï¼Œå‘é€ä¸æ¥æ”¶æ¶ˆæ¯

æˆ‘ä¼šå†™å¾—**ç®€å• + è¯¦ç»† + æ³¨é‡Šæ¸…æ™°**ï¼Œä½ å¯ä»¥å®Œæ•´è¿è¡Œã€‚

---

# ğŸ§± ä¸€ã€WebSocket èŠå¤©å®¤æœåŠ¡ç«¯ï¼ˆDartï¼‰

ä¿å­˜ä¸º `chat_server.dart`ï¼š

```dart
import 'dart:io';

/// WebSocket èŠå¤©å®¤æœåŠ¡ç«¯
///
/// åŠŸèƒ½ï¼š
/// - æ¥æ”¶å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥
/// - æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
/// - å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯
void main() async {
  // å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œç›‘å¬æœ¬åœ° 8080 ç«¯å£
  final server = await HttpServer.bind('localhost', 8080);
  print('âœ… WebSocket èŠå¤©å®¤æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œåœ°å€ï¼šws://localhost:8080');

  // è¿æ¥åˆ—è¡¨ï¼ˆå­˜å‚¨æ‰€æœ‰åœ¨çº¿çš„ WebSocket å®¢æˆ·ç«¯ï¼‰
  final List<WebSocket> clients = [];

  // ç›‘å¬è¿›å…¥çš„è¯·æ±‚
  await for (HttpRequest request in server) {
    // åˆ¤æ–­è¯·æ±‚æ˜¯å¦æ˜¯ WebSocket å‡çº§è¯·æ±‚
    if (WebSocketTransformer.isUpgradeRequest(request)) {
      // å‡çº§ä¸º WebSocket è¿æ¥
      final socket = await WebSocketTransformer.upgrade(request);
      clients.add(socket);
      print('ğŸ‘‹ æ–°ç”¨æˆ·åŠ å…¥èŠå¤©å®¤ï¼ˆå½“å‰åœ¨çº¿ï¼š${clients.length}ï¼‰');

      // ç›‘å¬è¯¥å®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯
      socket.listen((message) {
        print('ğŸ’¬ æ”¶åˆ°æ¶ˆæ¯ï¼š$message');

        // å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯
        for (var client in clients) {
          if (client != socket) {
            client.add(message);
          }
        }
      }, onDone: () {
        // å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ç§»é™¤
        clients.remove(socket);
        print('âŒ ç”¨æˆ·ç¦»å¼€ï¼ˆå½“å‰åœ¨çº¿ï¼š${clients.length}ï¼‰');
      });
    } else {
      // æ‹’ç»é WebSocket è¯·æ±‚
      request.response
        ..statusCode = HttpStatus.forbidden
        ..write('ä»…æ”¯æŒ WebSocket è¿æ¥')
        ..close();
    }
  }
}
```

---

âœ… **è¿è¡Œæ–¹æ³•ï¼š**

```bash
dart chat_server.dart
```

ç„¶åæ§åˆ¶å°ä¼šæ˜¾ç¤ºï¼š

```
âœ… WebSocket èŠå¤©å®¤æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œåœ°å€ï¼šws://localhost:8080
```

---

# ğŸ“± äºŒã€Flutter å®¢æˆ·ç«¯ï¼ˆClientï¼‰

åˆ›å»ºä¸€ä¸ª Flutter é¡¹ç›®ï¼ˆå¦‚ `flutter_chat_client`ï¼‰
åœ¨ `lib/main.dart` ä¸­æ›¿æ¢å¦‚ä¸‹å†…å®¹ğŸ‘‡ï¼š

```dart
import 'package:flutter/material.dart';
import 'dart:io';

void main() {
  runApp(const ChatApp());
}

/// Flutter èŠå¤©å®¤å®¢æˆ·ç«¯
class ChatApp extends StatelessWidget {
  const ChatApp({super.key});

  @override
  Widget build(BuildContext context) {
    return const MaterialApp(
      home: ChatPage(),
      debugShowCheckedModeBanner: false,
    );
  }
}

/// èŠå¤©ä¸»ç•Œé¢
class ChatPage extends StatefulWidget {
  const ChatPage({super.key});

  @override
  State<ChatPage> createState() => _ChatPageState();
}

class _ChatPageState extends State<ChatPage> {
  late WebSocket _socket;
  final List<String> _messages = []; // èŠå¤©æ¶ˆæ¯åˆ—è¡¨
  final TextEditingController _controller = TextEditingController();

  bool _isConnected = false;

  @override
  void initState() {
    super.initState();
    _connectToServer();
  }

  /// è¿æ¥ WebSocket æœåŠ¡å™¨
  Future<void> _connectToServer() async {
    try {
      _socket = await WebSocket.connect('ws://localhost:8080');
      setState(() {
        _isConnected = true;
      });
      print('âœ… å·²è¿æ¥ WebSocket æœåŠ¡å™¨');

      // ç›‘å¬æœåŠ¡å™¨æ¶ˆæ¯
      _socket.listen((data) {
        setState(() {
          _messages.add("ğŸ‘¤ å¯¹æ–¹: $data");
        });
      }, onDone: () {
        print('âš ï¸ æœåŠ¡å™¨å…³é—­');
        setState(() {
          _isConnected = false;
        });
      });
    } catch (e) {
      print('âŒ è¿æ¥å¤±è´¥: $e');
    }
  }

  /// å‘é€æ¶ˆæ¯
  void _sendMessage() {
    if (_controller.text.isNotEmpty && _isConnected) {
      final text = _controller.text.trim();
      _socket.add(text);
      setState(() {
        _messages.add("ğŸ˜Š æˆ‘: $text");
        _controller.clear();
      });
    }
  }

  @override
  void dispose() {
    _socket.close();
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("ğŸ’¬ Dart èŠå¤©å®¤")),
      body: Column(
        children: [
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.all(10),
              itemCount: _messages.length,
              itemBuilder: (context, index) => Align(
                alignment: _messages[index].startsWith("ğŸ˜Š")
                    ? Alignment.centerRight
                    : Alignment.centerLeft,
                child: Container(
                  padding: const EdgeInsets.all(10),
                  margin: const EdgeInsets.symmetric(vertical: 4),
                  decoration: BoxDecoration(
                    color: _messages[index].startsWith("ğŸ˜Š")
                        ? Colors.blue[200]
                        : Colors.grey[300],
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(_messages[index]),
                ),
              ),
            ),
          ),
          const Divider(height: 1),
          Row(
            children: [
              Expanded(
                child: TextField(
                  controller: _controller,
                  decoration: const InputDecoration(
                    hintText: "è¾“å…¥æ¶ˆæ¯...",
                    contentPadding: EdgeInsets.symmetric(horizontal: 12),
                  ),
                  onSubmitted: (_) => _sendMessage(),
                ),
              ),
              IconButton(
                icon: const Icon(Icons.send),
                onPressed: _sendMessage,
                color: Colors.blue,
              ),
            ],
          ),
        ],
      ),
    );
  }
}
```

---

# ğŸš€ ä¸‰ã€è¿è¡Œæ­¥éª¤

1ï¸âƒ£ å…ˆå¯åŠ¨æœåŠ¡å™¨ï¼š

```bash
dart chat_server.dart
```

2ï¸âƒ£ å¯åŠ¨ä¸¤ä¸ª Flutter æ¨¡æ‹Ÿå™¨æˆ–æµè§ˆå™¨ç«¯ï¼ˆè¿è¡Œç›¸åŒçš„ Flutter å®¢æˆ·ç«¯ï¼‰

* åœ¨ç¬¬ä¸€ä¸ªçª—å£è¾“å…¥æ¶ˆæ¯ â†’ ç¬¬äºŒä¸ªçª—å£ä¼šå®æ—¶æ˜¾ç¤ºã€‚
* è¿™æ˜¯ **WebSocket åŒå‘é€šä¿¡** çš„ç»å…¸æ•ˆæœã€‚

---

# ğŸ§  å››ã€å­¦ä¹ æ€»ç»“

| æ¦‚å¿µ                                    | è¯´æ˜                     |
| ------------------------------------- | ---------------------- |
| **WebSocket**                         | ä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œæ”¯æŒå®æ—¶æ•°æ®äº¤æ¢     |
| **HttpServer + WebSocketTransformer** | Dart åŸç”Ÿæ”¯æŒ WebSocket åè®® |
| **listen()**                          | å¼‚æ­¥ç›‘å¬æ¶ˆæ¯æµ                |
| **add()**                             | å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯           |
| **setState()**                        | æ›´æ–° Flutter UI          |

---

# ğŸ¯ äº”ã€å¯æ‰©å±•æ–¹å‘

* âœ… æ·»åŠ æ˜µç§°å’Œæ—¶é—´æˆ³
* âœ… æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆå­˜æ•°æ®åº“ï¼‰
* âœ… ç¾¤èŠ / ç§èŠ
* âœ… Flutter Web æ”¯æŒï¼ˆå¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­èŠå¤©ï¼‰

---

æ˜¯å¦å¸Œæœ›æˆ‘ä¸‹ä¸€æ­¥å¸®ä½ **å‡çº§æˆæ”¯æŒâ€œç”¨æˆ·å + æ¶ˆæ¯æ—¶é—´ + åœ¨çº¿äººæ•°ç»Ÿè®¡â€çš„ç‰ˆæœ¬**ï¼Ÿ
è¿™ä¸ªç‰ˆæœ¬ä¼šè®©ä½ æ›´è¿›ä¸€æ­¥æŒæ¡ Dart æœåŠ¡ç«¯ä¸ Flutter UI çš„æ•°æ®åŒæ­¥ã€‚
