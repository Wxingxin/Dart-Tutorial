éå¸¸å¥½ ğŸ‘
ä½ å·²ç»ä» Dart åŸºç¡€ã€å¼‚æ­¥ã€ç½‘ç»œç¼–ç¨‹å­¦åˆ°çœŸæ­£çš„ **æœåŠ¡ç«¯å®æˆ˜é˜¶æ®µ** äº†ï¼
æˆ‘ä»¬è¿™æ¬¡å°±æ¥åšä¸€ä¸ªç»å…¸çš„ã€**ç®€å•ä½†å®Œæ•´çš„ã€Œæ³¨å†Œ + ç™»å½•ã€åç«¯ç³»ç»Ÿ**ï¼Œ
ä½¿ç”¨ **çº¯ Dart + HttpServer + MongoDB**ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ¢æˆå†…å­˜æ•°æ®åº“ï¼‰ã€‚

---

## ğŸ¯ ä¸€ã€ç›®æ ‡åŠŸèƒ½

âœ… ç”¨æˆ·æ³¨å†Œ
âœ… ç”¨æˆ·ç™»å½•ï¼ˆéªŒè¯ç”¨æˆ·å + å¯†ç ï¼‰
âœ… JSON æ ¼å¼æ¥å£è¿”å›
âœ… ä½¿ç”¨ POST è¯·æ±‚
âœ… å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆMD5 / bcryptï¼‰
âœ… å¯æ¥å…¥ Flutter / Web å‰ç«¯

---

## ğŸ§± äºŒã€é¡¹ç›®ç»“æ„

```
dart_auth_server/
 â”œâ”€â”€ pubspec.yaml
 â””â”€â”€ bin/
     â””â”€â”€ server.dart
```

---

## ğŸ“¦ ä¸‰ã€ä¾èµ–é…ç½®

åœ¨ `pubspec.yaml` ä¸­æ·»åŠ ä¾èµ–ï¼š

```yaml
name: dart_auth_server
description: Simple Dart auth server
environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  mongo_dart: ^0.10.3
  crypto: ^3.0.3
```

ç„¶åè¿è¡Œï¼š

```bash
dart pub get
```

---

## ğŸ’» å››ã€æœåŠ¡ç«¯å®Œæ•´ä»£ç ï¼ˆå«è¯¦ç»†æ³¨é‡Šï¼‰

ä¿å­˜ä¸ºï¼š`bin/server.dart`

```dart
import 'dart:io';
import 'dart:convert';
import 'package:mongo_dart/mongo_dart.dart';
import 'package:crypto/crypto.dart';

/// âœ… å¯åŠ¨å‘½ä»¤ï¼šdart run bin/server.dart
///
/// ç®€æ˜“æ³¨å†Œ & ç™»å½•ç³»ç»Ÿ
/// åŠŸèƒ½ï¼š
/// 1ï¸âƒ£ æ³¨å†Œï¼šPOST /register { "username": "xx", "password": "123" }
/// 2ï¸âƒ£ ç™»å½•ï¼šPOST /login { "username": "xx", "password": "123" }

void main() async {
  // è¿æ¥ MongoDB æ•°æ®åº“
  final db = await Db.create("mongodb://localhost:27017/dart_auth");
  await db.open();
  final users = db.collection("users");

  // å¯åŠ¨ HTTP æœåŠ¡å™¨
  final server = await HttpServer.bind(InternetAddress.anyIPv4, 8080);
  print('ğŸš€ Dart Auth Server è¿è¡Œä¸­ï¼šhttp://localhost:8080');

  // ç›‘å¬è¯·æ±‚
  await for (HttpRequest request in server) {
    // å…è®¸è·¨åŸŸï¼ˆæ–¹ä¾¿å‰ç«¯è¯·æ±‚ï¼‰
    request.response.headers.add("Access-Control-Allow-Origin", "*");
    request.response.headers.add("Access-Control-Allow-Headers", "Content-Type");

    if (request.method == "OPTIONS") {
      request.response
        ..statusCode = 200
        ..close();
      continue;
    }

    // è·¯ç”±å¤„ç†
    if (request.uri.path == '/register' && request.method == 'POST') {
      await handleRegister(request, users);
    } else if (request.uri.path == '/login' && request.method == 'POST') {
      await handleLogin(request, users);
    } else {
      // æœªçŸ¥è·¯å¾„
      request.response
        ..statusCode = 404
        ..write(jsonEncode({'error': 'Not Found'}))
        ..close();
    }
  }
}

/// ç”¨æˆ·æ³¨å†Œ
Future<void> handleRegister(HttpRequest request, DbCollection users) async {
  try {
    final body = await utf8.decoder.bind(request).join();
    final data = jsonDecode(body);

    final username = data['username'];
    final password = data['password'];

    if (username == null || password == null) {
      throw Exception("ç¼ºå°‘å­—æ®µ");
    }

    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨
    final exists = await users.findOne({'username': username});
    if (exists != null) {
      request.response
        ..statusCode = 400
        ..write(jsonEncode({'error': 'ç”¨æˆ·åå·²å­˜åœ¨'}))
        ..close();
      return;
    }

    // ä½¿ç”¨ MD5 åŠ å¯†å¯†ç ï¼ˆå¯æ¢ bcryptï¼‰
    final hashed = md5.convert(utf8.encode(password)).toString();

    await users.insertOne({'username': username, 'password': hashed});
    request.response
      ..statusCode = 200
      ..write(jsonEncode({'message': 'æ³¨å†ŒæˆåŠŸ'}))
      ..close();
  } catch (e) {
    request.response
      ..statusCode = 400
      ..write(jsonEncode({'error': e.toString()}))
      ..close();
  }
}

/// ç”¨æˆ·ç™»å½•
Future<void> handleLogin(HttpRequest request, DbCollection users) async {
  try {
    final body = await utf8.decoder.bind(request).join();
    final data = jsonDecode(body);

    final username = data['username'];
    final password = data['password'];

    if (username == null || password == null) {
      throw Exception("ç¼ºå°‘å­—æ®µ");
    }

    final user = await users.findOne({'username': username});
    if (user == null) {
      request.response
        ..statusCode = 404
        ..write(jsonEncode({'error': 'ç”¨æˆ·ä¸å­˜åœ¨'}))
        ..close();
      return;
    }

    final hashed = md5.convert(utf8.encode(password)).toString();

    if (user['password'] == hashed) {
      request.response
        ..statusCode = 200
        ..write(jsonEncode({'message': 'ç™»å½•æˆåŠŸ'}))
        ..close();
    } else {
      request.response
        ..statusCode = 401
        ..write(jsonEncode({'error': 'å¯†ç é”™è¯¯'}))
        ..close();
    }
  } catch (e) {
    request.response
      ..statusCode = 400
      ..write(jsonEncode({'error': e.toString()}))
      ..close();
  }
}
```

---

## ğŸ§  äº”ã€è¿è¡Œä¸æµ‹è¯•

### 1ï¸âƒ£ å¯åŠ¨ MongoDB

```bash
mongod --dbpath <ä½ çš„æ•°æ®åº“è·¯å¾„>
```

### 2ï¸âƒ£ å¯åŠ¨ Dart æœåŠ¡ç«¯

```bash
dart run bin/server.dart
```

è¾“å‡ºï¼š

```
ğŸš€ Dart Auth Server è¿è¡Œä¸­ï¼šhttp://localhost:8080
```

---

### 3ï¸âƒ£ ä½¿ç”¨ Postman / curl æµ‹è¯•æ¥å£

#### æ³¨å†Œæ¥å£ï¼š

```
POST http://localhost:8080/register
Content-Type: application/json

{
  "username": "alice",
  "password": "123456"
}
```

è¿”å›ï¼š

```json
{"message": "æ³¨å†ŒæˆåŠŸ"}
```

#### ç™»å½•æ¥å£ï¼š

```
POST http://localhost:8080/login
Content-Type: application/json

{
  "username": "alice",
  "password": "123456"
}
```

è¿”å›ï¼š

```json
{"message": "ç™»å½•æˆåŠŸ"}
```

---

## ğŸ”’ å…­ã€è¿›é˜¶æ–¹å‘ï¼ˆå¯é€‰ï¼‰

| åŠŸèƒ½           | è¯´æ˜                             |
| ------------ | ------------------------------ |
| âœ… bcrypt åŠ å¯†  | ä½¿ç”¨ `package:bcrypt` æ›¿ä»£ md5ï¼Œæ›´å®‰å…¨ |
| âœ… JWT ä»¤ç‰Œ     | æ³¨å†Œåå‘æ”¾ç™»å½• Token                  |
| âœ… ç”¨æˆ·ä¿¡æ¯æ¥å£     | `/profile` è¿”å›å½“å‰ç”¨æˆ·èµ„æ–™            |
| âœ… Flutter å‰ç«¯ | ç›´æ¥ä½¿ç”¨ `http.post()` ä¸æ­¤æ¥å£äº¤äº’      |
| âœ… å¼‚æ­¥æµå¼å†™æ³•     | ä¼˜åŒ– IO æ€§èƒ½                       |

---

æ˜¯å¦å¸Œæœ›æˆ‘æ¥ç€å¸®ä½ å†™ä¸€ä¸ªå¯¹åº”çš„
**Flutter å‰ç«¯ï¼ˆæ³¨å†Œ + ç™»å½•é¡µé¢ + ä¸ Dart æœåŠ¡ç«¯äº¤äº’ï¼‰** ç¤ºä¾‹ï¼Ÿ
è¿™æ ·ä½ å°±å¯ä»¥ç›´æ¥ä»æ‰‹æœºæˆ–ç½‘é¡µç•Œé¢æ³¨å†Œã€ç™»å½•äº†ã€‚
